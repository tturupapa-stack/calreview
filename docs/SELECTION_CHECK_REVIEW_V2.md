# 당첨 확인 기능 구현 계획 v2.0 - 재검토 결과

> 작성일: 2024-12-19  
> 검토 관점: 보강된 기획의 현실성 및 실행 가능성 재평가

---

## ✅ 개선된 부분 (비판 반영됨)

### 1. 기술 스택 변경 ✅
- **이전**: Puppeteer/Playwright (비현실적)
- **현재**: Python 크롤러 + 별도 서버 또는 Cheerio + HTTP
- **평가**: ✅ 현실적이고 실행 가능한 선택

### 2. 일정 현실화 ✅
- **이전**: 4주 (과도하게 낙관적)
- **현재**: 8-12주 (최소 2배 이상)
- **평가**: ✅ 현실적인 일정

### 3. 범위 축소 ✅
- **이전**: Phase 1에서 여러 사이트
- **현재**: Phase 1은 리뷰노트 1개만
- **평가**: ✅ MVP 접근 방식 적절

### 4. 보안 강화 ✅
- 쿠키 암호화 저장 명시
- 세션 만료 감지 및 알림
- **평가**: ✅ 보안 고려사항 반영

### 5. 테스트 및 모니터링 추가 ✅
- 통합 테스트 계획
- Sentry 모니터링
- **평가**: ✅ 품질 보증 계획 포함

---

## ⚠️ 여전히 남아있는 문제점

### 1. **Phase 1 목표의 모순**

**문제점:**
```markdown
### Phase 1: 핵심 기능 구현 (우선순위: P0)
- [ ] 리뷰노트 당첨 확인 크롤러 완성
- [ ] 크롤러 API 실제 로직 구현
- [ ] 다른 주요 사이트 크롤러 구현 (최소 2-3개)  ← 여기!
```

**분석:**
- 문서 전반에서는 "리뷰노트 1개만"이라고 명시했지만
- Phase 1 목표에는 여전히 "다른 주요 사이트 크롤러 구현 (최소 2-3개)"가 포함됨
- 이는 범위 축소와 모순됨

**개선 방안:**
```markdown
### Phase 1: 핵심 기능 구현 (우선순위: P0)
- [ ] 리뷰노트 당첨 확인 크롤러 완성
- [ ] 크롤러 API 실제 로직 구현
- [ ] 세션 관리 및 보안 강화
- [ ] 테스트 및 모니터링 시스템 구축
```

---

### 2. **별도 서버 인프라의 구체적 계획 부족**

**문제점:**
- "Railway 또는 Render"라고만 언급
- 실제 구현 방법, API 구조, 비용 추정이 구체적이지 않음
- Python 크롤러를 어떻게 API로 노출할지 불명확

**개선 방안:**

#### 2.1 서버 선택 기준 명시
```markdown
### 별도 서버 선택 기준

**Railway (권장)**
- 장점: 설정 간단, GitHub 연동, 자동 배포
- 단점: 비용이 조금 더 비쌈
- 예상 비용: 월 $5-10 (Hobby 플랜)

**Render**
- 장점: 무료 티어 제공 (제한적)
- 단점: 무료 티어는 15분 후 sleep
- 예상 비용: 월 $7-15 (Paid 플랜)

**AWS EC2 (고급)**
- 장점: 완전한 제어, 확장성
- 단점: 설정 복잡, 비용 예측 어려움
- 예상 비용: 월 $10-20 (t3.micro)
```

#### 2.2 Python API 구조 명시
```python
# 예시: Flask 또는 FastAPI 사용
# crawler/api.py

from flask import Flask, request, jsonify
from crawler.sites.reviewnote import check_selection

app = Flask(__name__)

@app.route('/api/check-selection', methods=['POST'])
def check_selection():
    data = request.json
    site = data.get('site')
    campaign_url = data.get('campaignUrl')
    cookies = data.get('cookies')
    
    if site == 'reviewnote':
        result = check_selection(campaign_url, cookies)
        return jsonify({'isSelected': result})
    
    return jsonify({'error': 'Unsupported site'}), 400
```

---

### 3. **네이버 세션 쿠키 관리의 구체적 구현 방법 부족**

**문제점:**
- "쿠키 암호화 저장"이라고만 언급
- Supabase Vault 사용 방법이 구체적이지 않음
- 쿠키 포맷, 저장 구조, 복호화 방법이 불명확

**개선 방안:**

#### 3.1 쿠키 저장 구조 명시
```typescript
// 쿠키는 JSON 배열로 저장
// 예: [{name: 'NID_AUT', value: '...', domain: '.naver.com'}, ...]

// 암호화 저장 (Supabase Vault 또는 환경 변수)
// 또는 간단하게: AES-256 암호화 후 저장
```

#### 3.2 세션 만료 감지 로직
```typescript
// 세션 만료 감지 방법:
// 1. 크롤링 시도 시 401/403 에러 확인
// 2. "로그인이 필요합니다" 메시지 확인
// 3. 쿠키 만료 시간 추적 (가능한 경우)
```

---

### 4. **"내 신청 내역" 페이지 크롤링의 구체적 방법 부족**

**문제점:**
- 리뷰노트의 "내 신청 내역" 페이지 구조가 문서에 없음
- 어떤 URL을 크롤링할지, 어떤 HTML 요소를 파싱할지 불명확
- 당첨 여부를 어떻게 판단할지 구체적이지 않음

**개선 방안:**

#### 4.1 사전 조사 필요
```markdown
### 리뷰노트 "내 신청 내역" 페이지 분석 필요

**조사 항목:**
1. URL 구조: `https://www.reviewnote.co.kr/my/applications`?
2. 인증 방식: 네이버 로그인 세션 쿠키로 접근 가능한가?
3. HTML 구조: 
   - 당첨된 신청은 어떤 클래스/텍스트로 표시되는가?
   - "당첨", "선정", "합격" 등의 키워드?
4. API 존재 여부: Next.js이므로 `__NEXT_DATA__`에 데이터가 있을 수 있음
```

#### 4.2 프로토타입 구현 필요
- 실제 페이지를 크롤링하여 구조 파악
- 당첨 여부 판단 로직 프로토타입 작성
- 이후 공수 재추정

---

### 5. **에러 처리 및 재시도 로직의 구체성 부족**

**문제점:**
- "재시도 로직 (최소 3회, 지수 백오프)"라고만 언급
- 어떤 에러에 대해 재시도할지, 어떤 에러는 즉시 실패 처리할지 불명확
- 에러 분류가 구체적이지 않음

**개선 방안:**

#### 5.1 에러 분류 및 처리 전략
```typescript
// 에러 타입별 처리 전략

// 1. 네트워크 오류 (타임아웃, 연결 실패)
// → 재시도 (최대 3회, 지수 백오프: 1초, 2초, 4초)

// 2. 인증 오류 (401, 403, 세션 만료)
// → 즉시 실패, 사용자에게 재로그인 요청

// 3. 파싱 오류 (HTML 구조 변경)
// → 즉시 실패, 개발자에게 알림 (Sentry)

// 4. 사이트 오류 (500, 503)
// → 재시도 (최대 2회, 5초 간격)

// 5. Rate Limiting (429)
// → 재시도 (최대 1회, 10초 후)
```

---

### 6. **비용 추정의 부정확성**

**문제점:**
- "월 $5-20"이라고만 언급
- 실제 사용량에 따른 비용 변동 고려 부족
- Vercel 함수 실행 비용도 별도로 고려 필요

**개선 방안:**

#### 6.1 상세 비용 분석
```markdown
### 비용 추정 (월간)

**별도 서버 (Railway/Render)**
- 기본 플랜: $5-10
- 트래픽 증가 시: $10-20

**Vercel 함수 실행**
- 무료 플랜: 100GB-hours/월
- 예상 사용량: 
  - 크롤러 API 호출: 일 100회 × 5초 = 500초/일
  - 월간: 15,000초 = 4.2시간
  - 예상 비용: 무료 플랜 내 (하지만 Pro 권장)

**총 예상 비용:**
- 초기 (낮은 트래픽): 월 $5-10
- 성장 후 (높은 트래픽): 월 $20-40
```

---

### 7. **테스트 전략의 구체성 부족**

**문제점:**
- "통합 테스트", "모의 데이터 테스트"라고만 언급
- 실제 테스트 케이스, 테스트 데이터 구조가 불명확

**개선 방안:**

#### 7.1 테스트 케이스 명시
```markdown
### 테스트 케이스

**1. 정상 케이스**
- 당첨된 신청: `isSelected = true` 반환
- 미당첨 신청: `isSelected = false` 반환

**2. 에러 케이스**
- 세션 만료: 명확한 에러 메시지
- 네트워크 오류: 재시도 후 실패 시 에러
- 파싱 오류: 개발자 알림

**3. 엣지 케이스**
- 신청 내역이 없는 경우
- 당첨 여부가 불명확한 경우 (예: "심사 중")
- 여러 개의 동일한 체험단 신청
```

#### 7.2 모의 데이터 구조
```python
# 테스트용 HTML 샘플 저장
# tests/fixtures/reviewnote_selected.html
# tests/fixtures/reviewnote_not_selected.html
```

---

### 8. **성공 지표의 측정 방법 부족**

**문제점:**
- "성공률 60% 이상"이라고만 언급
- 어떻게 측정할지, 어떤 데이터를 수집할지 불명확

**개선 방안:**

#### 8.1 측정 방법 명시
```markdown
### 성공률 측정 방법

**분자**: 성공한 크롤링 수
- `isSelected` 값이 정확하게 반환된 경우
- 사용자가 수동으로 확인한 결과와 일치하는 경우

**분모**: 전체 크롤링 시도 수
- 성공 + 실패 (에러 발생)
- 세션 만료로 인한 실패는 제외

**데이터 수집:**
- 각 크롤링 시도마다 로그 저장
- 성공/실패 여부, 에러 타입, 소요 시간
- 주간 리포트 생성
```

---

### 9. **사이트별 크롤러 구현의 복잡도 분석 부족**

**문제점:**
- Phase 2에서 다른 사이트를 추가할 계획이지만
- 각 사이트의 "내 신청 내역" 페이지 구조가 완전히 다를 것으로 예상
- 사전 조사 없이는 공수 추정이 어려움

**개선 방안:**

#### 9.1 사전 조사 체크리스트
```markdown
### 사이트별 크롤러 구현 전 조사 항목

**각 사이트마다 확인:**
1. "내 신청 내역" 페이지 URL
2. 인증 방식 (네이버 로그인? 자체 로그인?)
3. HTML 구조 (서버 사이드 렌더링? 클라이언트 사이드?)
4. 당첨 여부 표시 방법 (텍스트? 클래스? API?)
5. 크롤링 가능 여부 (robots.txt 확인)
6. Rate Limiting 존재 여부
```

---

### 10. **법적 고려사항의 실행 계획 부족**

**문제점:**
- "법무 검토", "이용약관 확인"이라고만 언급
- 실제로 누가, 언제, 어떻게 확인할지 불명확

**개선 방안:**

#### 10.1 법적 검토 체크리스트
```markdown
### 법적 검토 체크리스트

**각 사이트마다 확인:**
- [ ] 이용약관에서 크롤링 금지 조항 확인
- [ ] robots.txt 확인
- [ ] 개인정보 처리방침 확인 (쿠키 사용 관련)
- [ ] 법무팀 또는 변호사 상담 (필요 시)

**사용자 동의:**
- [ ] 크롤링 사용에 대한 명시적 동의 UI
- [ ] 개인정보 처리방침 업데이트
- [ ] 쿠키 저장 및 활용에 대한 안내
```

---

## 💡 추가 개선 제안

### 1. **프로토타입 단계 추가**

Phase 1 시작 전에 **1주일 프로토타입 단계**를 추가하는 것을 권장:

```markdown
### Phase 0: 프로토타입 (1주)

**목표:**
- 리뷰노트 "내 신청 내역" 페이지 구조 파악
- 크롤링 가능 여부 확인
- 당첨 여부 판단 로직 프로토타입
- 공수 재추정

**결과물:**
- 사이트 구조 분석 문서
- 프로토타입 코드
- 수정된 공수 추정
```

### 2. **점진적 롤아웃 전략**

```markdown
### 롤아웃 전략

**1단계: 베타 테스트 (1-2주)**
- 소수 사용자에게만 제공
- 피드백 수집
- 버그 수정

**2단계: 제한적 공개 (2-4주)**
- 리뷰노트 사용자 중 일부만
- 성공률 모니터링
- 문제점 해결

**3단계: 전체 공개**
- 모든 사용자에게 제공
- 지속적 모니터링
```

### 3. **폴백(Fallback) 전략**

```markdown
### 크롤링 실패 시 대응

**자동 확인 실패 시:**
1. 사용자에게 명확한 에러 메시지 표시
2. 수동 입력 버튼 강조
3. "나중에 다시 시도" 옵션 제공

**세션 만료 시:**
1. "네이버로 다시 로그인" 버튼 표시
2. 재로그인 후 자동 재시도
```

---

## 📊 최종 평가

### 개선도: 8/10

**잘 개선된 부분:**
- ✅ 기술 스택 현실화
- ✅ 일정 현실화
- ✅ 범위 축소
- ✅ 보안 고려사항 추가
- ✅ 테스트 계획 추가

**여전히 부족한 부분:**
- ⚠️ Phase 1 목표 모순 (수정 필요)
- ⚠️ 구체적 구현 방법 부족
- ⚠️ 비용 추정의 정확성
- ⚠️ 사전 조사 부족

### 권장 사항

1. **즉시 수정**: Phase 1 목표에서 "다른 사이트" 제거
2. **프로토타입 단계 추가**: 1주일 사전 조사
3. **구체적 구현 방법 문서화**: API 구조, 쿠키 저장 구조 등
4. **비용 모니터링 계획**: 실제 사용량 추적 및 알림

---

**결론**: 전반적으로 크게 개선되었지만, 여전히 **구체적 구현 세부사항**이 부족합니다. 프로토타입 단계를 추가하고, 실제 구현에 들어가기 전에 사전 조사를 철저히 하는 것을 강력히 권장합니다.
