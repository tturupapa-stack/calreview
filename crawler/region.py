from typing import Optional
import re

def normalize_region(raw_region: Optional[str]) -> Optional[str]:
    """
    지역명을 표준화합니다.
    - 도/광역시 표기 통일 (서울, 경기, 부산, 대구, 인천, 광주, 대전, 울산, 세종, 강원, 충북, 충남, 전북, 전남, 경북, 경남, 제주)
    - "배송", "전국" 등은 그대로 유지
    - "시/도 구/군" 형태로 띄어쓰기 정규화
    - 채널명(인스타, 클립 등)이 지역으로 잘못 들어온 경우 None 반환
    """
    if not raw_region:
        return None

    region = raw_region.strip()

    # 1. 특수 케이스 처리
    if region in ["배송", "전국", "재택", "기자단"]:
        return region
    
    # 2. 채널명 등 오염 데이터 필터링
    garbage_keywords = [
        "인스타", "클립", "블로그", "유튜브", "틱톡", "릴스", "쇼츠", 
        "구매평", "페이백", "기자단", "포토", "배송형", "체험형", "상품평", "인플루언서", "재택"
    ]
    if any(k in region for k in garbage_keywords):
        return None  # 지역 정보 아님

    # 3. 구분자 통일 (슬래시 -> 공백)
    # "경기/수원" -> "경기 수원"
    region = region.replace("/", " ")
    
    # 4. 공백으로 분리
    parts = region.split()
    if not parts:
        return None

    # 5. 첫 번째 단어(도/광역시) 정규화
    first = parts[0]
    
    # 매핑 테이블 (도/광역시 + 주요 도시 -> 도/광역시 포함 형태로)
    province_map = {
        # 도/광역시 정규화
        "서울특별시": "서울", "서울시": "서울",
        "경기도": "경기",
        "인천광역시": "인천", "인천시": "인천",
        "부산광역시": "부산", "부산시": "부산",
        "대구광역시": "대구", "대구시": "대구",
        "광주광역시": "광주", "광주시": "광주",
        "대전광역시": "대전", "대전시": "대전",
        "울산광역시": "울산", "울산시": "울산",
        "세종특별자치시": "세종", "세종시": "세종",
        "강원도": "강원", "강원특별자치도": "강원",
        "충청북도": "충북", "충북": "충북",
        "충청남도": "충남", "충남": "충남",
        "전라북도": "전북", "전북특별자치도": "전북", "전북": "전북",
        "전라남도": "전남", "전남": "전남",
        "경상북도": "경북", "경북": "경북",
        "경상남도": "경남", "경남": "경남",
        "제주도": "제주", "제주특별자치도": "제주", "제주시": "제주", "서귀포시": "제주",
        
        # 주요 도시 -> 도/시 매핑 (prefix 누락된 경우 복구)
        "수원": "경기 수원", "수원시": "경기 수원",
        "성남": "경기 성남", "성남시": "경기 성남",
        "고양": "경기 고양", "고양시": "경기 고양",
        "용인": "경기 용인", "용인시": "경기 용인",
        "부천": "경기 부천", "부천시": "경기 부천",
        "안산": "경기 안산", "안산시": "경기 안산",
        "안양": "경기 안양", "안양시": "경기 안양",
        "남양주": "경기 남양주", "남양주시": "경기 남양주",
        "화성": "경기 화성", "화성시": "경기 화성",
        "평택": "경기 평택", "평택시": "경기 평택",
        "의정부": "경기 의정부", "의정부시": "경기 의정부",
        "시흥": "경기 시흥", "시흥시": "경기 시흥",
        "파주": "경기 파주", "파주시": "경기 파주",
        "김포": "경기 김포", "김포시": "경기 김포",
        "광명": "경기 광명", "광명시": "경기 광명",
        "광주": "광주", # 광주광역시 (경기 광주는 '경기 광주'로 들어오거나 '경기도 광주'로 들어옴)
        "군포": "경기 군포", "군포시": "경기 군포",
        "이천": "경기 이천", "이천시": "경기 이천",
        "양주": "경기 양주", "양주시": "경기 양주",
        "오산": "경기 오산", "오산시": "경기 오산",
        "구리": "경기 구리", "구리시": "경기 구리",
        "안성": "경기 안성", "안성시": "경기 안성",
        "포천": "경기 포천", "포천시": "경기 포천",
        "의왕": "경기 의왕", "의왕시": "경기 의왕",
        "하남": "경기 하남", "하남시": "경기 하남",
        "가평": "경기 가평", "가평군": "경기 가평",
        "양평": "경기 양평", "양평군": "경기 양평",
        "동탄": "경기 화성",
        "분당": "경기 성남",
        
        "천안": "충남 천안", "천안시": "충남 천안",
        "아산": "충남 아산", "아산시": "충남 아산",
        "청주": "충북 청주", "청주시": "충북 청주",
        "전주": "전북 전주", "전주시": "전북 전주",
        "포항": "경북 포항", "포항시": "경북 포항",
        "구미": "경북 구미", "구미시": "경북 구미",
        "경주": "경북 경주", "경주시": "경북 경주",
        "창원": "경남 창원", "창원시": "경남 창원",
        "김해": "경남 김해", "김해시": "경남 김해",
        "진주": "경남 진주", "진주시": "경남 진주",
        "강릉": "강원 강릉", "강릉시": "강원 강릉",
        "원주": "강원 원주", "원주시": "강원 원주",
        "춘천": "강원 춘천", "춘천시": "강원 춘천",
        
        # 서울 주요 핫플레이스/구 (서울 누락 복구)
        "강남": "서울 강남구", "강남구": "서울 강남구",
        "서초": "서울 서초구", "서초구": "서울 서초구",
        "송파": "서울 송파구", "송파구": "서울 송파구",
        "마포": "서울 마포구", "마포구": "서울 마포구",
        "용산": "서울 용산구", "용산구": "서울 용산구",
        "성동": "서울 성동구", "성동구": "서울 성동구",
        "종로": "서울 종로구", "종로구": "서울 종로구",
        "중구": "서울 중구", "강서구": "서울 강서구", # 부산 강서구도 있지만 서울 확률 높음
        "영등포": "서울 영등포", "영등포구": "서울 영등포",
        "홍대": "서울 마포구", 
        "강남역": "서울 강남구",
        "신사": "서울 강남구",
        "합정": "서울 마포구",
        "명동": "서울 중구",
        "성수": "서울 성동구",
        "반포": "서울 서초구",
        "당산": "서울 영등포",
        "신촌": "서울 서대문구",
        
        "제주스냅": "제주",
    }
    
    # 1. Reversed Case Detection (e.g., "남구 대구", "달성군 대구")
    # If standard province is found at index 1, swap.
    if len(parts) >= 2:
        second_norm = province_map.get(parts[1], parts[1])
        if second_norm in ["서울", "부산", "대구", "인천", "광주", "대전", "울산", "세종", "경기", "강원", "충북", "충남", "전북", "전남", "경북", "경남", "제주"]:
             # Swap parts
             parts[0], parts[1] = parts[1], parts[0]
             first = parts[0]

    # 매핑 적용
    normalized_first = province_map.get(first, first)
    parts[0] = normalized_first
    
    # 다시 합치기 (최대 2단계까지만)
    # "경기 수원시 팔달구" -> "경기 수원시" (시/구 까지만)
    if len(parts) > 2:
        return f"{parts[0]} {parts[1]}"
    
    # "경기 수원" -> "경기 수원"
    return " ".join(parts)
